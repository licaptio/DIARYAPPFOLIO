<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Toma de Pedidos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .menu {
      text-align: center;
      margin-bottom: 20px;
    }
    .menu button {
      padding: 10px 20px;
      margin: 0 10px;
      font-weight: bold;
    }
    .section {
      display: none;
      max-width: 600px;
      margin: auto;
    }
    .active {
      display: block;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    button {
      padding: 10px;
      margin: 2px;
    }
    .note {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .archived {
      background-color: #eee;
    }
  </style>
</head>

<body>
  <h1>Toma de Pedidos</h1>

  <div class="menu">
    <button onclick="mostrarSeccion('captura')">Capturar Pedido</button>
    <button onclick="mostrarSeccion('resumen')">Pedidos Guardados</button>
    <button onclick="mostrarSeccion('archivo')">Archivo</button>
  </div>

  <div id="captura" class="section active">
    <h2>Capturar Pedido</h2>
    <input type="text" id="titulo" placeholder="TÃ­tulo">
    <textarea id="descripcion" rows="4" placeholder="DescripciÃ³n"></textarea>
    <button onclick="obtenerFolioYGuardar()">Guardar</button>
  </div>

  <div id="resumen" class="section">
    <h2>Pedidos Guardados</h2>
    <div id="listaNotas"></div>
  </div>

  <div id="archivo" class="section">
    <h2>Archivo</h2>
    <div id="listaArchivados"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    runTransaction,
    addDoc,
    getDocs,
    query,
    where,
    orderBy,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBbWF230CSuc_RyX2nZVZxFPGkPrQsQXxE",
    authDomain: "notasfoliador.firebaseapp.com",
    projectId: "notasfoliador",
    storageBucket: "notasfoliador.appspot.com",
    messagingSenderId: "449665263510",
    appId: "1:449665263510:web:b049e4c02babe203da1fb7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("ðŸ”’ Debes iniciar sesiÃ³n para usar esta funciÃ³n.");
      window.location.href = "login.html";
    }
  });

  let editandoId = null;

  function mostrarNotas() {
    const contenedor = document.getElementById("listaNotas");
    contenedor.innerHTML = "";

    const q = query(collection(db, "pedidosAppWeb"), where("archivado", "==", false), orderBy("fecha", "desc"));
    getDocs(q).then((querySnapshot) => {
      querySnapshot.forEach((docSnap) => {
        const nota = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement("div");
        div.className = "note";
        div.innerHTML = `
          <strong>Folio ${nota.folio ?? 'N/A'} - ${nota.titulo}</strong><br>
          <p>${nota.descripcion}</p>
          <button onclick="editarNota('${id}', '${nota.titulo}', \`${nota.descripcion.replace(/`/g, "\`")}\`)">Editar</button>
          <button onclick="eliminarNota('${id}')">Eliminar</button>
          <button onclick="archivarNota('${id}', true)">Archivar</button>
        `;
        contenedor.appendChild(div);
      });
    }).catch((error) => {
      console.error("Error al mostrar notas: ", error);
    });
  }

  function mostrarArchivados() {
    const contenedor = document.getElementById("listaArchivados");
    contenedor.innerHTML = "";

    const q = query(collection(db, "pedidosAppWeb"), where("archivado", "==", true), orderBy("fecha", "desc"));
    getDocs(q).then((querySnapshot) => {
      querySnapshot.forEach((docSnap) => {
        const nota = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement("div");
        div.className = "note archived";
        div.innerHTML = `
          <strong>${nota.titulo}</strong><br>
          <p>${nota.descripcion}</p>
          <button onclick="archivarNota('${id}', false)">Desarchivar</button>
          <button onclick="eliminarNota('${id}')">Eliminar</button>
        `;
        contenedor.appendChild(div);
      });
    }).catch((error) => {
      console.error("Error al mostrar archivados: ", error);
    });
  }

  function eliminarNota(id) {
    if (!confirm("Â¿Eliminar esta nota?")) return;

    deleteDoc(doc(db, "pedidosAppWeb", id)).then(() => {
      alert("Pedido eliminado de Firebase");
      mostrarNotas();
      mostrarArchivados();
    }).catch((error) => {
      console.error("Error al eliminar:", error);
      alert("Hubo un error al eliminar el pedido.");
    });
  }

  function editarNota(id, titulo, descripcion) {
    document.getElementById("titulo").value = titulo;
    document.getElementById("descripcion").value = descripcion;
    editandoId = id;
    mostrarSeccion('captura');
  }

  function archivarNota(id, estado) {
    updateDoc(doc(db, "pedidosAppWeb", id), { archivado: estado }).then(() => {
      mostrarNotas();
      mostrarArchivados();
    }).catch((error) => {
      console.error("Error al archivar/desarchivar:", error);
      alert("No se pudo cambiar el estado de archivo.");
    });
  }

  function obtenerFolioYGuardar() {
    const titulo = document.getElementById("titulo").value.trim();
    const descripcion = document.getElementById("descripcion").value.trim();
    if (!titulo || !descripcion) return alert("Llena ambos campos");

    const folioRef = doc(db, "config", "folio");

    runTransaction(db, async (transaction) => {
      const folioDoc = await transaction.get(folioRef);
      let folioActual = folioDoc.exists() ? folioDoc.data().valor + 1 : 1;

      transaction.set(folioRef, { valor: folioActual });

      const datos = {
        titulo,
        descripcion,
        fecha: new Date().toISOString(),
        folio: folioActual,
        archivado: false
      };

      await addDoc(collection(db, "pedidosAppWeb"), datos);
    }).then(() => {
      alert("Pedido guardado con folio");
      document.getElementById("titulo").value = "";
      document.getElementById("descripcion").value = "";
      mostrarNotas();
      mostrarArchivados();
      mostrarSeccion('resumen');
    }).catch((error) => {
      console.error("Error al guardar con folio:", error);
      alert("Hubo un error al guardar el pedido con folio.");
    });
  }

  function mostrarSeccion(id) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (id === "resumen") mostrarNotas();
    if (id === "archivo") mostrarArchivados();
  }

  mostrarNotas();
  mostrarArchivados();
</script>
</body>
</html>
