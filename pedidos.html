<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Toma de Pedidos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .menu {
      text-align: center;
      margin-bottom: 20px;
    }
    .menu button {
      padding: 10px 20px;
      margin: 0 10px;
      font-weight: bold;
    }
    .section {
      display: none;
      max-width: 600px;
      margin: auto;
    }
    .active {
      display: block;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    button {
      padding: 10px;
      margin: 2px;
    }
    .note {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    .archived {
      background-color: #eee;
    }
  </style>
</head>

<body>
  <h1>Toma de Pedidos</h1>

  <!-- MenÃº para alternar secciones -->
  <div class="menu">
    <button onclick="mostrarSeccion('captura')">Capturar Pedido</button>
    <button onclick="mostrarSeccion('resumen')">Pedidos Guardados</button>
    <button onclick="mostrarSeccion('archivo')">Archivo</button>
  </div>

  <!-- SecciÃ³n de captura -->
  <div id="captura" class="section active">
    <h2>Capturar Pedido</h2>
    <input type="text" id="titulo" placeholder="TÃ­tulo">
    <textarea id="descripcion" rows="4" placeholder="DescripciÃ³n"></textarea>
<button onclick="obtenerFolioYGuardar()">Guardar</button>

  </div>

  <!-- SecciÃ³n de pedidos guardados -->
  <div id="resumen" class="section">
    <h2>Pedidos Guardados</h2>
    <div id="listaNotas"></div>
  </div>

  <!-- SecciÃ³n de archivo -->
  <div id="archivo" class="section">
    <h2>Archivo</h2>
    <div id="listaArchivados"></div>
  </div>
 
  <script>
    let editandoIndex = null;



function mostrarNotas() {
  const contenedor = document.getElementById("listaNotas");
  contenedor.innerHTML = "";

  db.collection("pedidosAppWeb")
    .where("archivado", "==", false)
    .orderBy("fecha", "desc")
    .get()
    .then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const nota = doc.data();
        const id = doc.id;

        const div = document.createElement("div");
        div.className = "note";
div.innerHTML = `
  <strong>Folio ${nota.folio ?? 'N/A'} - ${nota.titulo}</strong><br>
  <p>${nota.descripcion}</p>
          <button onclick="editarNota('${id}', '${nota.titulo}', \`${nota.descripcion.replace(/`/g, "\\`")}\`)">Editar</button>
          <button onclick="eliminarNota('${id}')">Eliminar</button>
          <button onclick="archivarNota('${id}', true)">Archivar</button>
        `;
        contenedor.appendChild(div);
      });
    })
    .catch((error) => {
      console.error("Error al mostrar notas: ", error);
    });
}


function mostrarArchivados() {
  const contenedor = document.getElementById("listaArchivados");
  contenedor.innerHTML = "";

  db.collection("pedidosAppWeb")
    .where("archivado", "==", true)
    .orderBy("fecha", "desc")
    .get()
    .then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const nota = doc.data();
        const id = doc.id;

        const div = document.createElement("div");
        div.className = "note archived";
        div.innerHTML = `
          <strong>${nota.titulo}</strong><br>
          <p>${nota.descripcion}</p>
          <button onclick="archivarNota('${id}', false)">Desarchivar</button>
          <button onclick="eliminarNota('${id}')">Eliminar</button>
        `;
        contenedor.appendChild(div);
      });
    })
    .catch((error) => {
      console.error("Error al mostrar archivados: ", error);
    });
}


function eliminarNota(id) {
  if (!confirm("Â¿Eliminar esta nota?")) return;

  db.collection("pedidosAppWeb")
    .doc(id)
    .delete()
    .then(() => {
      alert("Pedido eliminado de Firebase");
      mostrarNotas();
      mostrarArchivados();
    })
    .catch((error) => {
      console.error("Error al eliminar:", error);
      alert("Hubo un error al eliminar el pedido.");
    });
}


let editandoId = null; // âœ… Variable global para saber si estamos editando

function editarNota(id, titulo, descripcion) {
  document.getElementById("titulo").value = titulo;
  document.getElementById("descripcion").value = descripcion;
  editandoId = id;
  mostrarSeccion('captura');
}


function archivarNota(id, estado) {
  db.collection("pedidosAppWeb")
    .doc(id)
    .update({ archivado: estado })
    .then(() => {
      mostrarNotas();
      mostrarArchivados();
    })
    .catch((error) => {
      console.error("Error al archivar/desarchivar:", error);
      alert("No se pudo cambiar el estado de archivo.");
    });
}

    function mostrarSeccion(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === "resumen") mostrarNotas();
      if (id === "archivo") mostrarArchivados();
    }

    // Mostrar notas si ya hay algo al cargar
    mostrarNotas();
    mostrarArchivados();
  </script>

<style>
  body.oculto {
    visibility: hidden;
  }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBbWF230CSuc_RyX2nZVZxFPGkPrQsQXxE",
    authDomain: "notasfoliador.firebaseapp.com",
    projectId: "notasfoliador",
    storageBucket: "notasfoliador.appspot.com",
    messagingSenderId: "449665263510",
    appId: "1:449665263510:web:b049e4c02babe203da1fb7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
import { setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

setPersistence(auth, browserLocalPersistence)
  .then(() => {
    document.body.classList.add("oculto");
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        alert("ðŸ”’ Debes iniciar sesiÃ³n para usar esta funciÃ³n.");
        window.location.href = "login.html";
      } else {
        document.body.classList.remove("oculto");
        window.db = db;
      }
    });
  })
  .catch((error) => {
    console.error("Error al establecer persistencia:", error);
  });


</script>


</body>
</html>
